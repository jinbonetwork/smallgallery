<?php
class Smallgallery_Walker_Comment extends Walker_Comment {
	 
	var $tree_type = 'comment';
	var $db_fields = array(
		'parent' => 'comment_parent',
		'id' => 'comment_ID'
	);
 
	function __construct() {
		$comments_title = __('',TEXTDOMAIN);

		echo <<<CONSTRUCT

		<h3 id="comments-title">{$comments_title}</h3>
		<ul id="comment-list">

CONSTRUCT;
	}
	 
	function start_lvl(&$output,$depth=0,$args=array()){	  
		$GLOBALS['comment_depth'] = $depth + 1;
		echo <<<START_LVL

				<ul class="children">

START_LVL;
	}
 
	function end_lvl(&$output,$depth=0,$args=array()){
		$GLOBALS['comment_depth'] = $depth + 1;
		echo <<<END_LVL

		</ul><!-- /.children -->

END_LVL;
	}
	 
	function start_el(&$output,$comment,$depth,$args,$id=0){
		$depth++;
		$GLOBALS['comment_depth'] = $depth;
		$GLOBALS['comment'] = $comment;
		$parent_class = (empty($args['has_children'])?'':'parent');

		$replyOptions = array_merge($args,array(
			'add_below' => $add_below,
			'depth' => $depth,
			'max_depth' => $args['max_depth']
		));
		$comment->reply_link = get_comment_reply_link($replyOptions);

		ob_start();
		edit_comment_link(__('(Edit)',TEXTDOMAIN));
		$comment->edit_link = ob_get_contents();
		ob_end_clean();

		$comment->says = __(' says,',TEXTDOMAIN);
		$comment->at = __(' at ',TEXTDOMAIN);
		$comment->permalink = htmlspecialchars(get_comment_link());
		$comment->class = comment_class($parent_class,null,null,false);
		$comment->portrait = $args['avatar_size']!=0?get_avatar($comment,$args['avatar_size']):'';
		$comment->author_linked = get_comment_author_link();
		$comment->date_filtered = get_comment_time(get_option('date_format')."<span class='at'>{$comment->at}</span>".get_option('time_format'));

		if(!$comment->comment_approved){
			$comment->text_filtered = __('Your comment is awaiting moderation.',TEXTDOMAIN);
		}else{
			$comment->text_filtered = get_comment_text();
		}
		$comment->text_filtered = apply_filters('comment_text',$comment->text_filtered);

		echo <<<START_EL
		 
		<li {$comment->class} id="comment-{$comment->comment_ID}">
			<div id="comment-body-{$comment->comment_ID}" class="comment-body">
				<div class="comment-author vcard author">
					{$comment->portrait}
					<cite class="fn n author-name">{$comment->author_linked}<span class="says">{$comment->says}</span></cite>
				</div><!--/.comment-author-->
				<div id="comment-content-{$comment->comment_ID}" class="comment-content">
					{$comment->text_filtered}
				</div><!--/.comment-content-->
				<div class="comment-meta comment-meta-data">
					<a class="comment-date" href="{$comment->permalink}">{$comment->date_filtered}</a>
					{$comment->edit_link}
				</div><!--/.comment-meta-->
				<div class="reply">
					{$comment->reply_link}
				</div><!--/.reply-->
			</div><!--/.comment-body-->

START_EL;
	}
 
	function end_el(&$output,$comment,$depth=0,$args=array()){
		echo <<<END_EL

		</li><!-- /#comment-' . get_comment_ID() . ' -->
		 
END_EL;
	 }

	function __destruct() {
		echo <<<DESTRUCT

	</ul><!-- /#comment-list -->

DESTRUCT;
	}
}
?>
